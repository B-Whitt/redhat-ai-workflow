# Skill: Manage Secrets
# Manage encrypted secrets with Ansible Vault and OpenSSL

name: manage_secrets
description: |
  Manage encrypted secrets using Ansible Vault and OpenSSL.

  This skill handles:
  - Viewing encrypted vault files
  - Encrypting and decrypting files
  - Encrypting individual strings
  - Generating RSA keys
  - Creating file digests

  Uses: ansible_vault_encrypt, ansible_vault_decrypt, ansible_vault_view,
        ansible_vault_encrypt_string, openssl_genrsa, openssl_dgst,
        ssh_fingerprint
version: "1.0"

links:
  depends_on: []
  validates: []
  validated_by: []
  chains_to:
    - ansible_configure_vm
  provides_context_for:
    - ansible_configure_vm

inputs:
  - name: action
    type: string
    required: true
    description: "Action to perform (view|encrypt|decrypt|rotate|generate)"

  - name: file_path
    type: string
    required: false
    default: ""
    description: "Path to the secrets file"

  - name: variable_name
    type: string
    required: false
    default: ""
    description: "Variable name for string encryption"

steps:
  # ==================== LOAD DEVOPS PERSONA ====================

  - name: load_devops_persona
    description: "Load devops persona for secrets management tools"
    tool: persona_load
    args:
      persona_name: "devops"

  # ==================== KNOWLEDGE INTEGRATION ====================

  - name: check_vault_known_issues
    description: "Check for known vault issues"
    compute: |
      vault_issues = memory.check_known_issues("ansible_vault", "") or {}
      openssl_issues = memory.check_known_issues("openssl", "") or {}

      all_issues = []
      for issues in [vault_issues, openssl_issues]:
          if issues and issues.get("matches"):
              all_issues.extend(issues.get("matches", [])[:2])

      result = {
          "has_known_issues": len(all_issues) > 0,
          "issues": all_issues[:5],
      }
    output: vault_known_issues
    on_error: continue

  # ==================== VAULT OPERATIONS ====================

  - name: view_vault_file
    description: "View an encrypted vault file"
    condition: "inputs.action == 'view' and inputs.file_path"
    tool: ansible_vault_view
    args:
      file: "{{ inputs.file_path }}"
    output: vault_view_raw
    on_error: continue

  - name: encrypt_vault_file
    description: "Encrypt a file with Ansible Vault"
    condition: "inputs.action == 'encrypt' and inputs.file_path"
    tool: ansible_vault_encrypt
    args:
      file: "{{ inputs.file_path }}"
    output: vault_encrypt_raw
    on_error: continue

  - name: decrypt_vault_file
    description: "Decrypt a vault-encrypted file"
    condition: "inputs.action == 'decrypt' and inputs.file_path"
    tool: ansible_vault_decrypt
    args:
      file: "{{ inputs.file_path }}"
    output: vault_decrypt_raw
    on_error: continue

  - name: encrypt_string
    description: "Encrypt a string variable with Ansible Vault"
    condition: "inputs.action == 'encrypt' and inputs.variable_name"
    tool: ansible_vault_encrypt_string
    args:
      name: "{{ inputs.variable_name }}"
    output: vault_string_raw
    on_error: continue

  # ==================== OPENSSL OPERATIONS ====================

  - name: generate_rsa_key
    description: "Generate an RSA private key"
    condition: "inputs.action == 'generate'"
    tool: openssl_genrsa
    args:
      bits: 4096
    output: rsa_key_raw
    on_error: continue

  - name: compute_digest
    description: "Compute file digest"
    condition: "inputs.file_path"
    tool: openssl_dgst
    args:
      file: "{{ inputs.file_path }}"
      algorithm: "sha256"
    output: digest_raw
    on_error: continue

  # ==================== SSH FINGERPRINT ====================

  - name: get_ssh_fingerprint
    description: "Get SSH key fingerprint"
    condition: "inputs.file_path"
    tool: ssh_fingerprint
    args:
      key_file: "{{ inputs.file_path }}"
    output: ssh_fp_raw
    on_error: continue

  # ==================== FAILURE DETECTION ====================

  - name: detect_secrets_failures
    description: "Detect failure patterns from secrets operations"
    compute: |
      errors_detected = []

      view_text = str(vault_view_raw) if 'vault_view_raw' in dir() and vault_view_raw else ""
      encrypt_text = str(vault_encrypt_raw) if 'vault_encrypt_raw' in dir() and vault_encrypt_raw else ""
      combined = view_text + encrypt_text

      if "vault password" in combined.lower() or "decryption failed" in combined.lower():
          errors_detected.append({
              "tool": "ansible_vault",
              "pattern": "vault password",
              "cause": "Vault password not provided or incorrect",
              "fix": "Set ANSIBLE_VAULT_PASSWORD_FILE or provide --vault-password-file"
          })
      if "no such file" in combined.lower():
          errors_detected.append({
              "tool": "ansible_vault",
              "pattern": "file not found",
              "cause": "Specified file does not exist",
              "fix": "Verify the file path is correct"
          })

      result = errors_detected
    output: secrets_errors_detected
    on_error: continue

  - name: learn_vault_password_failure
    description: "Learn from vault password failures"
    condition: "secrets_errors_detected and any(e.get('pattern') == 'vault password' for e in secrets_errors_detected)"
    tool: learn_tool_fix
    args:
      tool_name: "ansible_vault"
      error_pattern: "vault password"
      root_cause: "Vault password not provided or incorrect"
      fix_description: "Set ANSIBLE_VAULT_PASSWORD_FILE env var or provide --vault-password-file flag"
    output: vault_password_fix_learned
    on_error: continue

  # ==================== SESSION LOG ====================

  - name: log_session
    description: "Log skill execution to session"
    tool: memory_session_log
    args:
      action: "Manage secrets: {{ inputs.action }}"
      details: "action={{ inputs.action }}, file={{ inputs.file_path }}, variable={{ inputs.variable_name }}"
    on_error: continue

outputs:
  - name: report
    value: |
      ## Manage Secrets

      **Action:** {{ inputs.action }}
      **File:** {{ inputs.file_path if inputs.file_path else "N/A" }}
      **Variable:** {{ inputs.variable_name if inputs.variable_name else "N/A" }}

      ---

      {% if inputs.action == 'view' %}
      ### Vault Contents
      ```
      {{ vault_view_raw | string | truncate(800) if vault_view_raw else "Could not view vault file" }}
      ```
      {% endif %}

      {% if inputs.action == 'encrypt' %}
      ### Encryption Result
      {% if inputs.file_path %}
      Vault: {{ vault_encrypt_raw | string | truncate(200) if vault_encrypt_raw else "N/A" }}
      {% endif %}
      {% if inputs.variable_name %}
      ```
      {{ vault_string_raw | string | truncate(500) if vault_string_raw else "N/A" }}
      ```
      {% endif %}
      {% endif %}

      {% if inputs.action == 'decrypt' %}
      ### Decryption Result
      Vault: {{ vault_decrypt_raw | string | truncate(200) if vault_decrypt_raw else "N/A" }}
      {% endif %}

      {% if inputs.action == 'generate' %}
      ### Generated Key
      ```
      {{ rsa_key_raw | string | truncate(200) if rsa_key_raw else "Key generation failed" }}
      ```
      {% endif %}

      {% if digest_raw %}
      ### File Digest (SHA-256)
      ```
      {{ digest_raw | string | truncate(200) }}
      ```
      {% endif %}

      {% if ssh_fp_raw %}
      ### SSH Fingerprint
      ```
      {{ ssh_fp_raw | string | truncate(200) }}
      ```
      {% endif %}

      {% if vault_known_issues and vault_known_issues.has_known_issues %}
      ---

      ### Known Issues

      {% for issue in vault_known_issues.issues[:3] %}
      - {{ issue.pattern if issue.pattern else issue }}
      {% endfor %}
      {% endif %}

  - name: context
    value:
      action: "{{ inputs.action }}"
      file_path: "{{ inputs.file_path }}"
