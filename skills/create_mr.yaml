# Skill: Create Merge Request
# Creates a properly formatted MR with Jira link

name: create_mr
description: Create a merge request with Jira integration
version: "1.0"

inputs:
  - name: issue_key
    type: string
    required: true
    description: "Jira issue key for linking"
  - name: repo
    type: string
    required: true
    description: "Repository name"
  - name: draft
    type: boolean
    default: true
    description: "Create as draft MR"
  - name: target_branch
    type: string
    default: "main"
    description: "Target branch for MR"

steps:
  # Step 1: Get issue details for MR description
  - name: get_issue
    tool: jira_view_issue
    args:
      issue_key: "{{ inputs.issue_key }}"
    output: issue

  # Step 2: Check git status
  - name: check_status
    tool: git_status
    args:
      repo: "{{ inputs.repo }}"
    output: status

  # Step 3: Get current branch
  - name: get_branch
    tool: git_branch_list
    args:
      repo: "{{ inputs.repo }}"
    output: branches
    # Current branch is marked with *

  # Step 4: Push if needed
  - name: push_branch
    tool: git_push
    args:
      repo: "{{ inputs.repo }}"
      set_upstream: true
    output: push_result

  # Step 5: Build MR description
  # Note: jira_url comes from config.json via config
  - name: build_description
    compute: |
      # Get Jira URL from config (loaded by skill engine)
      jira_url = config.get('jira', {}).get('url', 'https://jira.example.com')
      description = f"""## Summary
      {issue.summary}

      ## Jira
      {jira_url}/browse/{inputs.issue_key}

      ## Changes
      <!-- Describe your changes -->

      ## Testing
      - [ ] Unit tests pass
      - [ ] Integration tests pass
      - [ ] Manual testing completed

      ## Checklist
      - [ ] Code follows project conventions
      - [ ] Documentation updated if needed
      - [ ] No secrets or sensitive data
      """
      return description
    output: description

  # Step 6: Create the MR
  - name: create_mr
    tool: gitlab_mr_create
    args:
      project: "{{ inputs.repo }}"
      title: "{{ inputs.issue_key }} - {{ issue.summary[:50] }}"
      description: "{{ description }}"
      target_branch: "{{ inputs.target_branch }}"
      draft: "{{ inputs.draft }}"
    output: mr

  # Step 7: Update Jira with MR link
  - name: update_jira
    tool: jira_add_comment
    args:
      issue_key: "{{ inputs.issue_key }}"
      comment: "MR created: {{ mr.web_url }}"
    on_error: continue

  # Step 8: Update Jira status to In Review
  - name: update_status
    condition: "{{ not inputs.draft }}"
    tool: jira_set_status
    args:
      issue_key: "{{ inputs.issue_key }}"
      status: "In Review"
    on_error: continue

outputs:
  - name: summary
    value: |
      ## âœ… Merge Request Created
      
      **MR:** {{ mr.title }}
      **URL:** {{ mr.web_url }}
      **Status:** {{ "Draft" if inputs.draft else "Ready for Review" }}
      
      ### Next Steps
      {% if inputs.draft %}
      1. Complete your changes
      2. Mark as ready: `gitlab_mr_update mr_id={{ mr.iid }} draft=false`
      {% else %}
      1. Wait for pipeline to complete
      2. Request review from teammates
      3. Address feedback
      {% endif %}
  
  - name: mr_url
    value: "{{ mr.web_url }}"

