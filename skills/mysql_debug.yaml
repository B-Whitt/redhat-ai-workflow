# Skill: MySQL Debug
# Debug MySQL/MariaDB database issues

name: mysql_debug
description: |
  Debug MySQL or MariaDB database issues.

  This skill inspects:
  - Database list and table structure
  - Active processes and connections
  - Server status and variables
  - Table definitions and schemas
  - Slow queries and lock contention

  Uses: mysql_query, mysql_databases, mysql_tables, mysql_describe,
        mysql_show_create_table, mysql_processlist, mysql_status
version: "1.0"

links:
  depends_on: []
  validates: []
  chains_to:
    - create_jira_issue
    - learn_pattern
    - debug_prod
  provides_context_for:
    - create_jira_issue
    - debug_prod
  validated_by:
    - environment_overview

inputs:
  - name: host
    type: string
    required: false
    default: "localhost"
    description: "MySQL host to connect to"

  - name: database
    type: string
    required: false
    default: ""
    description: "Database name to inspect"

  - name: issue_description
    type: string
    required: false
    default: ""
    description: "Description of the database issue to investigate"

  - name: check_processes
    type: boolean
    required: false
    default: true
    description: "Include process list and connection analysis"

steps:
  # ==================== LOAD DEVELOPER PERSONA ====================

  - name: load_developer_persona
    description: "Load developer persona for database tools"
    tool: persona_load
    args:
      persona_name: "developer"

  # ==================== KNOWLEDGE INTEGRATION ====================

  - name: check_mysql_known_issues
    description: "Check for known MySQL issues"
    compute: |
      mysql_issues = memory.check_known_issues("mysql", "") or {}
      db_issues = memory.check_known_issues("database", "") or {}
      mariadb_issues = memory.check_known_issues("mariadb", "") or {}

      all_issues = []
      for issues in [mysql_issues, db_issues, mariadb_issues]:
          if issues and issues.get("matches"):
              all_issues.extend(issues.get("matches", [])[:2])

      result = {
          "has_known_issues": len(all_issues) > 0,
          "issues": all_issues[:5],
      }
    output: mysql_known_issues
    on_error: continue

  # ==================== DATABASE DISCOVERY ====================

  - name: list_databases
    description: "List all databases on the server"
    tool: mysql_databases
    args: {}
    output: databases_raw
    on_error: continue

  - name: list_tables
    description: "List tables in the target database"
    condition: "inputs.database"
    tool: mysql_tables
    args:
      database: "{{ inputs.database }}"
    output: tables_raw
    on_error: continue

  # ==================== TABLE INSPECTION ====================

  - name: describe_tables
    description: "Describe table structure"
    condition: "inputs.database"
    tool: mysql_describe
    args:
      database: "{{ inputs.database }}"
    output: describe_raw
    on_error: continue

  - name: show_create_table
    description: "Show CREATE TABLE statements"
    condition: "inputs.database"
    tool: mysql_show_create_table
    args:
      database: "{{ inputs.database }}"
    output: create_table_raw
    on_error: continue

  # ==================== PROCESS AND CONNECTION CHECKS ====================

  - name: check_processlist
    description: "Check active MySQL processes"
    condition: "inputs.check_processes"
    tool: mysql_processlist
    args: {}
    output: processlist_raw
    on_error: continue

  - name: check_status
    description: "Check MySQL server status"
    tool: mysql_status
    args: {}
    output: status_raw
    on_error: continue

  - name: run_diagnostic_query
    description: "Run diagnostic query for slow queries and connections"
    tool: mysql_query
    args:
      query: "SELECT id, user, host, db, command, time, state, LEFT(info, 100) AS query_preview FROM information_schema.processlist WHERE command != 'Sleep' AND time > 5 ORDER BY time DESC LIMIT 10;"
    output: slow_queries_raw
    on_error: continue

  # ==================== ANALYSIS ====================

  - name: analyze_mysql_health
    description: "Analyze MySQL health from collected data"
    compute: |
      processlist_text = str(processlist_raw) if 'processlist_raw' in dir() and processlist_raw else ""
      status_text = str(status_raw) if 'status_raw' in dir() and status_raw else ""
      slow_text = str(slow_queries_raw) if 'slow_queries_raw' in dir() and slow_queries_raw else ""

      issues = []
      import re

      # Check for long-running queries
      if slow_text and slow_text.strip() and "empty set" not in slow_text.lower():
          issues.append("Long-running queries detected (>5 seconds)")

      # Check thread count
      threads_match = re.search(r'Threads_connected[:\s|]+(\d+)', status_text)
      threads = int(threads_match.group(1)) if threads_match else 0
      if threads > 50:
          issues.append(f"High thread count: {threads}")

      # Check max connections from status output
      max_conn_match = re.search(r'max_connections[:\s|]+(\d+)', status_text)
      max_conn = int(max_conn_match.group(1)) if max_conn_match else 0
      if max_conn > 0 and threads > 0 and (threads / max_conn) > 0.8:
          issues.append(f"Connection usage at {int(threads/max_conn*100)}% of max ({threads}/{max_conn})")

      # Check for locks in processlist
      if "Locked" in processlist_text or "Waiting for" in processlist_text:
          issues.append("Table locks or lock waits detected")

      # Check uptime
      uptime_match = re.search(r'Uptime[:\s|]+(\d+)', status_text)
      uptime = int(uptime_match.group(1)) if uptime_match else 0

      result = {
          "issues": issues,
          "issue_count": len(issues),
          "healthy": len(issues) == 0,
          "threads_connected": threads,
          "max_connections": max_conn,
          "uptime_seconds": uptime,
      }
    output: mysql_health

  # ==================== LEARNING FROM FAILURES ====================

  - name: detect_mysql_debug_failures
    description: "Detect failure patterns from MySQL debugging"
    compute: |
      errors_detected = []

      db_text = str(databases_raw) if 'databases_raw' in dir() and databases_raw else ""
      status_text = str(status_raw) if 'status_raw' in dir() and status_raw else ""
      combined = db_text + status_text

      if "access denied" in combined.lower():
          errors_detected.append({
              "tool": "mysql_databases",
              "pattern": "access denied",
              "cause": "MySQL authentication failed",
              "fix": "Verify MySQL credentials and user permissions"
          })
      if "can't connect" in combined.lower() or "connection refused" in combined.lower():
          errors_detected.append({
              "tool": "mysql_databases",
              "pattern": "connection refused",
              "cause": "MySQL server not running or not accessible",
              "fix": "Start MySQL with: podman start mysql or systemctl start mysqld"
          })

      result = errors_detected
    output: mysql_debug_errors_detected
    on_error: continue

  - name: learn_mysql_connection_failure
    description: "Learn from MySQL connection failures"
    condition: "mysql_debug_errors_detected and any(e.get('pattern') == 'connection refused' for e in mysql_debug_errors_detected)"
    tool: learn_tool_fix
    args:
      tool_name: "mysql_databases"
      error_pattern: "connection refused"
      root_cause: "MySQL server not running or not accessible"
      fix_description: "Start MySQL with: podman start mysql or systemctl start mysqld"
    output: mysql_connection_fix_learned
    on_error: continue

  - name: learn_mysql_auth_failure
    description: "Learn from MySQL auth failures"
    condition: "mysql_debug_errors_detected and any(e.get('pattern') == 'access denied' for e in mysql_debug_errors_detected)"
    tool: learn_tool_fix
    args:
      tool_name: "mysql_databases"
      error_pattern: "access denied"
      root_cause: "MySQL authentication failed"
      fix_description: "Verify MySQL credentials and user permissions"
    output: mysql_auth_fix_learned
    on_error: continue

  - name: log_session
    description: "Log MySQL debug session"
    tool: memory_session_log
    args:
      action: "MySQL debug on {{ inputs.host }}"
      details: "database={{ inputs.database if inputs.database else 'all' }}, healthy={{ mysql_health.healthy if mysql_health else 'unknown' }}, issues={{ mysql_health.issue_count if mysql_health else 0 }}"
    on_error: continue

outputs:
  - name: report
    value: |
      ## MySQL Debug: {{ inputs.host }}

      {% if inputs.issue_description %}
      **Issue:** {{ inputs.issue_description }}
      {% endif %}

      **Database:** {{ inputs.database if inputs.database else "all" }}
      **Health:** {{ "Healthy" if mysql_health.healthy else "Issues Detected" }}

      ---

      ### Issues Found ({{ mysql_health.issue_count }})

      {% for issue in mysql_health.issues %}
      - {{ issue }}
      {% endfor %}

      {% if mysql_health.issue_count == 0 %}
      No issues detected.
      {% endif %}

      ---

      ### Server Status

      | Metric | Value |
      |--------|-------|
      | Threads Connected | {{ mysql_health.threads_connected }} |
      | Max Connections | {{ mysql_health.max_connections }} |
      | Uptime | {{ mysql_health.uptime_seconds }}s |

      ---

      ### Databases

      ```
      {{ databases_raw | string | truncate(400) if databases_raw else "No database list" }}
      ```

      {% if tables_raw %}
      ---

      ### Tables ({{ inputs.database }})

      ```
      {{ tables_raw | string | truncate(500) }}
      ```
      {% endif %}

      {% if describe_raw %}
      ---

      ### Table Structure

      ```
      {{ describe_raw | string | truncate(500) }}
      ```
      {% endif %}

      ---

      ### Active Processes

      ```
      {{ processlist_raw | string | truncate(500) if processlist_raw else "No process data" }}
      ```

      ---

      ### Long Running Queries

      ```
      {{ slow_queries_raw | string | truncate(500) if slow_queries_raw else "None" }}
      ```

      {% if mysql_known_issues and mysql_known_issues.has_known_issues %}
      ---

      ### Known Issues

      {% for issue in mysql_known_issues.issues[:3] %}
      - {{ issue.pattern if issue.pattern else issue }}
      {% endfor %}
      {% endif %}
