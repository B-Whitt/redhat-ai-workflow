# AI Workflow Project Rules

## ‚õî CRITICAL: Git Safety Rules

**NEVER run `git checkout` on files without explicit user permission!**

This has caused catastrophic loss of uncommitted work. Before ANY git operation that could discard changes:
1. **ASK the user first** - "Can I revert file X? This will discard uncommitted changes."
2. **Check `git status`** - See what's modified
3. **Check `git diff`** - See what would be lost
4. **Consider `git stash`** - Preserve changes before destructive operations

Destructive git commands that require explicit permission:
- `git checkout -- <file>` (discards changes)
- `git reset --hard` (discards all changes)
- `git clean -fd` (deletes untracked files)
- `git stash drop` (deletes stashed changes)

## On Session Start - TRACK YOUR SESSION ID!

**IMPORTANT:** Multiple Cursor chats share the same MCP server. You MUST track your session_id to maintain separate context per chat.

```python
# Start a NEW session - SAVE the returned session_id!
session_start()  # Returns something like "Session ID: abc123" - REMEMBER THIS!

# To check YOUR session (not another chat's), pass your session_id:
session_info(session_id="abc123")  # Gets YOUR session info

# To resume a previous session:
session_start(session_id="abc123")  # Resumes existing session

# Start with specific options:
session_start(agent="devops")       # DevOps/monitoring
session_start(agent="developer")    # Coding/PRs  
session_start(agent="incident")     # Incidents
session_start(agent="release")      # Releases
session_start(name="Fixing AAP-12345")  # Named session
```

**Session Management:**
```python
session_list()                    # List all sessions
session_switch(session_id="...")  # Switch to different session
session_rename(name="...")        # Rename session
```

**Why track session_id?** Without it, `session_info()` returns whichever session was most recently active - which might be from a DIFFERENT chat window!

## üîÑ Dynamic Agent Loading

**Tools switch automatically when you load a new agent!**

This is a single MCP server that dynamically loads/unloads tools based on the active agent.

```
You: Load the devops agent
Claude: [calls agent_load("devops")]
        Server unloads current tools, loads k8s_basic/bonfire_basic/jira_basic/quay (~74 tools)
        Cursor receives tools/list_changed notification and refreshes
```

## Available Agents

Load an agent when the task matches their expertise:

- **Developer** (coding, PRs): `agent_load("developer")` ‚Üí workflow, git_basic, gitlab_basic, jira_basic (~78 tools)
- **DevOps** (deployments, ephemeral, k8s): `agent_load("devops")` ‚Üí workflow, k8s_basic, bonfire_basic, jira_basic, quay (~74 tools)
- **Incident** (production issues): `agent_load("incident")` ‚Üí workflow, k8s_basic, prometheus_basic, kibana, jira_basic, alertmanager (~78 tools)
- **Release** (shipping): `agent_load("release")` ‚Üí workflow, konflux_basic, quay, jira_basic, git_basic (~91 tools)

> **Note:** All personas include `jira_basic`. Use `tool_exec()` for `_extra` module tools when needed.

## Available Skills

Use skills for common workflows instead of figuring out steps manually:

- **Starting work**: `skill_run("start_work", '{"issue_key": "AAP-XXXXX", "repo": "backend"}')`
- **Creating MR**: `skill_run("create_mr", '{"issue_key": "AAP-XXXXX", "repo": "backend"}')`
- **Investigating alerts**: `skill_run("investigate_alert", '{"environment": "stage"}')`

## Memory Usage

- **Log important actions**: `memory_session_log("action", "details")`
- **Track active work**: `memory_append("state/current_work", "active_issues", '{...}')`
- **Save learned patterns**: `memory_write("learned/patterns", content)` for reusable knowledge

## Key Conventions

- Commit messages: Use `git_commit` tool - format from `config.json`: `{issue_key} - {type}({scope}): {description}`
- Branch names: `aap-xxxxx-short-description`
- Always link Jira issues in MR descriptions
- Check pipeline status after pushing

## Project Context

This is the Automation Analytics workflow assistant. Key namespaces:
- Konflux: `aap-aa-tenant`
- Stage: `tower-analytics-stage`
- Production: `tower-analytics-prod`

## ‚ö†Ô∏è CRITICAL: Ephemeral Cluster Rules

**NEVER copy kubeconfig files!** Each environment has its own config:
- `~/.kube/config.s` = stage
- `~/.kube/config.p` = production
- `~/.kube/config.e` = ephemeral

```bash
# WRONG - NEVER DO THIS:
cp ~/.kube/config.e ~/.kube/config

# RIGHT - use --kubeconfig flag:
kubectl --kubeconfig=~/.kube/config.e get pods -n ephemeral-xxx
oc --kubeconfig=~/.kube/config.e get pods -n ephemeral-xxx

# RIGHT - use KUBECONFIG env for bonfire:
KUBECONFIG=~/.kube/config.e bonfire namespace list --mine
```

## Ephemeral Deployment Rules

1. **Use the skill**: `skill_run("test_mr_ephemeral", '{"mr_id": 1459}')`
2. **Image tags must be FULL 40-char git SHA** - short SHAs (8 chars) don't exist in Quay
3. **Only release YOUR namespaces**: `bonfire namespace list --mine`
4. **ITS deploy pattern requires sha256 digest**, not git SHA for IMAGE_TAG

## ClowdApp Deployment

When deploying from **automation-analytics-backend** repo:
- **Ask which ClowdApp** to deploy: main or billing
- **Default to main** if user doesn't specify
- Main ClowdApp: `tower-analytics-clowdapp`
- Billing ClowdApp: `tower-analytics-billing-clowdapp`

```python
# Main (default):
skill_run("test_mr_ephemeral", '{"mr_id": 1459, "billing": false}')

# Billing:
skill_run("test_mr_ephemeral", '{"mr_id": 1459, "billing": true}')
```

## Namespace Safety

```bash
# Check YOUR namespaces only:
KUBECONFIG=~/.kube/config.e bonfire namespace list --mine

# NEVER release namespaces you don't own
```

## üîß Auto-Debug: Self-Healing Tools

When an MCP tool fails (returns ‚ùå), you can fix the tool itself:

### Workflow

1. **Tool fails** ‚Üí Look for the hint: `üí° To auto-fix: debug_tool('tool_name')`
2. **Call debug_tool** ‚Üí `debug_tool('bonfire_namespace_release', 'error message')`
3. **Analyze the source** ‚Üí Compare error to code, identify the bug
4. **Propose a fix** ‚Üí Show exact `search_replace` edit
5. **Ask user to confirm** ‚Üí "Found bug: missing --force flag. Apply fix?"
6. **Apply and commit** ‚Üí `git commit -m "fix(tool_name): description"`

### Example

```
Tool output: ‚ùå Failed to release namespace
             üí° To auto-fix: `debug_tool('bonfire_namespace_release')`

You: [call debug_tool('bonfire_namespace_release', 'Output is not a TTY. Aborting.')]

Claude: "I found the bug. The bonfire CLI prompts for confirmation but we're
         not passing --force. Here's the fix:

         File: mcp-servers/aa-bonfire/src/tools.py
         - args = ['namespace', 'release', namespace]
         + args = ['namespace', 'release', namespace, '--force']

         Apply this fix?"

User: "yes"

Claude: [applies fix, commits, retries operation]
```

### Common Fixable Bugs

| Error Pattern | Likely Cause |
|---------------|--------------|
| "Output is not a TTY" | Missing --force/--yes flag |
| "Unknown flag: --state" | CLI syntax changed |
| "Unauthorized" | Auth not passed correctly |
| "manifest unknown" | Wrong image tag format |
